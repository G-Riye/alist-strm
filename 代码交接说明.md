# Alist STRM Generator 代码交接说明

## 📋 项目概述

**项目名称**: Alist STRM Generator  
**版本**: v6.1.8  
**功能**: 基于WebDAV的STRM文件生成器，支持自动扫描、生成STRM文件、下载元数据等功能

## 🏗️ 项目结构

```
alist-strm/
├── 📁 核心文件
│   ├── app.py                    # Flask Web应用主文件
│   ├── main.py                   # STRM文件生成核心逻辑
│   ├── strm_validator.py         # STRM文件验证和生成脚本
│   ├── db_handler.py             # 数据库操作处理
│   ├── logger.py                 # 日志系统
│   └── task_scheduler.py         # 定时任务调度器
│
├── 📁 启动文件
│   ├── start_app.py              # 应用启动脚本
│   ├── run_local.py              # 本地运行脚本
│   └── test_run_local.py         # 本地测试脚本
│
├── 📁 配置文件
│   ├── requirements.txt          # Python依赖包
│   ├── version.json              # 版本信息
│   ├── config.db                 # SQLite数据库
│   └── supervisord.conf          # Supervisor配置
│
├── 📁 模板文件 (templates/)
│   ├── index.html                # 主布局模板
│   ├── home.html                 # 首页
│   ├── configs.html              # 配置管理页面
│   ├── new_config.html           # 新建配置页面
│   ├── edit_config.html          # 编辑配置页面
│   ├── scheduled_tasks.html      # 定时任务页面
│   ├── system_monitor.html       # 系统监控页面
│   ├── logs_single.html          # 日志查看页面
│   └── ... (其他模板文件)
│
├── 📁 静态文件 (static/)
│   ├── css/                      # CSS样式文件
│   ├── js/                       # JavaScript文件
│   ├── images/                   # 图片资源
│   └── webfonts/                 # 字体文件
│
├── 📁 日志和缓存
│   ├── logs/                     # 日志文件目录
│   ├── cache/                    # 缓存文件目录
│   └── invalid_file_trees/       # 失效文件树记录
│
├── 📁 Docker相关
│   ├── Dockerfile                # Docker镜像构建文件
│   ├── docker-compose.yml        # Docker Compose配置
│   └── docker-compose.unraid.yml # Unraid专用配置
│
└── 📁 文档
    ├── README.md                 # 项目说明
    ├── README_DOCKER.md          # Docker使用说明
    ├── CHANGELOG.md              # 更新日志
    └── STRM_SUFFIX_FEATURE.md    # STRM后缀功能说明
```

## 🔧 核心功能模块

### 1. Web应用 (app.py)
**主要功能**:
- Flask Web界面，提供配置管理、任务调度、系统监控等功能
- 用户认证和会话管理
- 配置CRUD操作
- 定时任务管理
- 系统资源监控
- 日志查看和管理

**关键路由**:
```python
@app.route('/')                    # 首页
@app.route('/configs')             # 配置管理
@app.route('/new')                 # 新建配置
@app.route('/edit/<int:config_id>') # 编辑配置
@app.route('/run_selected_configs') # 运行选定配置
@app.route('/generate_strm_files/<int:config_id>') # 生成STRM文件
@app.route('/system_monitor')      # 系统监控
@app.route('/api/system_info')     # 系统信息API
@app.route('/api/process_monitor') # 进程监控API
```

### 2. STRM生成核心 (main.py)
**主要功能**:
- WebDAV连接和文件扫描
- STRM文件生成
- 元数据文件下载
- 目录树缓存管理
- 增量/全量更新支持

**关键函数**:
```python
def connect_webdav(config)         # WebDAV连接
def list_files_recursive_with_cache() # 递归文件扫描
def create_strm_file()             # 创建STRM文件
def download_file()                # 下载文件
def process_with_cache()           # 缓存处理
def build_local_directory_tree()   # 构建本地目录树
```

### 3. 数据库操作 (db_handler.py)
**主要功能**:
- SQLite数据库连接管理
- 配置信息存储和检索
- 用户凭证管理
- 脚本配置管理

**关键方法**:
```python
def get_webdav_config(config_id)   # 获取WebDAV配置
def set_user_credentials()         # 设置用户凭证
def get_script_config()            # 获取脚本配置
def initialize_tables()            # 初始化数据表
```

### 4. 日志系统 (logger.py)
**主要功能**:
- 日志文件创建和管理
- 日志级别控制
- 文件轮转和权限设置

**关键函数**:
```python
def setup_logger(name, task_id=None) # 设置日志记录器
```

### 5. 定时任务 (task_scheduler.py)
**主要功能**:
- Cron任务管理
- 任务调度和监控
- 任务状态跟踪

**关键函数**:
```python
def add_tasks_to_cron()            # 添加定时任务
def list_tasks_in_cron()           # 列出定时任务
def delete_tasks_from_cron()       # 删除定时任务
def run_task_immediately()         # 立即运行任务
```

## 🗄️ 数据库结构

### config表 (配置信息)
```sql
CREATE TABLE config (
    config_id INTEGER PRIMARY KEY,
    config_name TEXT,
    url TEXT,
    username TEXT,
    password TEXT,
    rootpath TEXT,
    target_directory TEXT,
    download_interval_range TEXT,
    download_enabled INTEGER,
    update_mode TEXT,
    strm_suffix TEXT
);
```

### user_config表 (用户配置)
```sql
CREATE TABLE user_config (
    id INTEGER PRIMARY KEY,
    username TEXT,
    password_hash TEXT,
    video_formats TEXT,
    subtitle_formats TEXT,
    image_formats TEXT,
    metadata_formats TEXT,
    size_threshold INTEGER
);
```

## ⚙️ 配置说明

### 1. WebDAV配置
- **config_name**: 配置别名
- **url**: Alist服务器地址
- **username/password**: 登录凭证
- **rootpath**: 监控的根路径
- **target_directory**: 本地目标目录
- **download_interval_range**: 下载间隔范围 (如: "1-3")
- **download_enabled**: 是否启用下载功能 (0/1)
- **update_mode**: 更新模式 (incremental/full)
- **strm_suffix**: STRM文件后缀 (如: "-转码")

### 2. 脚本配置
- **video_formats**: 视频文件格式 (如: "mkv,mp4,avi")
- **subtitle_formats**: 字幕文件格式 (如: "srt,ass,sub")
- **image_formats**: 图片文件格式 (如: "jpg,png,nfo")
- **metadata_formats**: 元数据文件格式 (如: "nfo")
- **size_threshold**: 文件大小阈值 (MB)

## 🚀 部署方式

### 1. 本地运行
```bash
# 安装依赖
pip install -r requirements.txt

# 启动应用
python start_app.py
```

### 2. Docker部署
```bash
# 构建镜像
docker build -t alist-strm .

# 运行容器
docker-compose up -d
```

### 3. Unraid部署
使用 `docker-compose.unraid.yml` 配置文件进行部署。

## 📊 监控功能

### 系统监控页面
- **CPU使用率**: 实时CPU使用情况
- **内存使用**: 内存占用和可用情况
- **磁盘使用**: 磁盘空间使用情况
- **网络流量**: 网络I/O统计
- **进程监控**: Python进程状态监控
- **文件权限**: 关键目录权限检查
- **模块检查**: Python模块安装状态
- **WebDAV连接测试**: 配置连接状态测试

### 日志监控
- **实时日志**: 通过Web界面查看运行日志
- **日志分页**: 支持大量日志的分页显示
- **日志搜索**: 按配置ID筛选日志
- **错误追踪**: 详细的错误信息和堆栈跟踪

## 🔍 故障排查

### 常见问题

1. **程序提前退出**
   - 检查 `download_enabled` 配置
   - 查看日志中的错误信息
   - 确认WebDAV连接状态

2. **STRM文件未生成**
   - 检查视频文件格式配置
   - 确认文件大小阈值设置
   - 查看目标目录权限

3. **下载功能异常**
   - 检查网络连接
   - 确认文件格式配置
   - 查看下载间隔设置

4. **Web界面无法访问**
   - 检查端口配置
   - 确认防火墙设置
   - 查看应用启动日志

### 调试工具

1. **系统监控页面**: 实时查看系统状态
2. **进程监控**: 查看Python进程运行状态
3. **WebDAV测试**: 测试配置连接状态
4. **模块检查**: 确认依赖包安装状态

## 📝 开发说明

### 代码规范
- 使用Python 3.9+
- 遵循PEP 8编码规范
- 添加适当的注释和文档字符串
- 使用类型提示 (可选)

### 扩展开发
1. **添加新功能**: 在相应模块中添加功能函数
2. **修改界面**: 编辑templates目录下的HTML模板
3. **数据库变更**: 修改db_handler.py中的数据库操作
4. **配置扩展**: 在config表中添加新字段

### 测试建议
1. **单元测试**: 为核心函数编写单元测试
2. **集成测试**: 测试WebDAV连接和文件处理
3. **性能测试**: 测试大量文件的处理性能
4. **兼容性测试**: 测试不同环境的兼容性

## 📞 技术支持

### 联系方式
- **项目地址**: GitHub仓库
- **问题反馈**: GitHub Issues
- **文档更新**: 及时更新README和CHANGELOG

### 维护建议
1. **定期备份**: 备份配置数据库和日志文件
2. **版本管理**: 使用Git进行版本控制
3. **监控告警**: 设置系统监控和告警
4. **日志轮转**: 定期清理和轮转日志文件

---

**交接完成时间**: 2025年8月17日  
**交接版本**: v6.1.8  
**维护人员**: [填写维护人员信息]
